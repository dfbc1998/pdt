<!-- src/app/features/projects/project-detail/project-detail.component.html -->
<app-header [title]="project?.title || 'Detalle del Proyecto'" [showBackButton]="true"></app-header>

<ion-content class="ion-padding">
  <!-- Loading State -->
  @if (isLoading) {
  <div class="flex justify-center items-center min-h-96">
    <ion-spinner name="crescent" class="text-4xl"></ion-spinner>
  </div>
  } @else if (project) {
  <!-- Project Header -->
  <ion-card class="mb-4">
    <ion-card-header>
      <div class="flex justify-between items-start">
        <div class="flex-1">
          <ion-card-title class="text-xl font-bold mb-2">{{ project.title }}</ion-card-title>
          <div class="flex flex-wrap gap-2 items-center">
            <ion-badge [color]="getStatusColor(project.status)">
              {{ getStatusLabel(project.status) }}
            </ion-badge>
            @if (project.isFeatured) {
            <ion-badge color="warning">Destacado</ion-badge>
            }
            <ion-chip>
              <ion-icon name="business-outline"></ion-icon>
              <ion-label>{{ project.category }}</ion-label>
            </ion-chip>
          </div>
        </div>

        <!-- Action Buttons (Only for project owner) -->
        @if (isProjectOwner) {
        <div class="flex gap-2 ml-4">
          @if (canEditProject) {
          <ion-button fill="outline" size="small" (click)="editProject()" class="text-sm">
            <ion-icon name="edit" slot="start"></ion-icon>
            Editar
          </ion-button>
          }

          <ion-button fill="outline" color="danger" size="small" (click)="confirmDeleteProject()"
            [disabled]="isDeleting" class="text-sm">
            <ion-icon name="trash" slot="start"></ion-icon>
            @if (isDeleting) {
            <ion-spinner name="lines-small"></ion-spinner>
            } @else {
            Eliminar
            }
          </ion-button>
        </div>
        }
      </div>
    </ion-card-header>

    <ion-card-content>
      <!-- Key Project Info -->
      <ion-grid class="p-0">
        <ion-row>
          <ion-col size="12" size-md="4">
            <div class="flex items-center gap-2 mb-2">
              <ion-icon name="cash" class="text-green-600"></ion-icon>
              <span class="font-semibold">{{ getBudgetText() }}</span>
            </div>
          </ion-col>
          <ion-col size="12" size-md="4">
            <div class="flex items-center gap-2 mb-2">
              <ion-icon name="time-outline" class="text-blue-600"></ion-icon>
              <span>{{ getTimelineText() }}</span>
            </div>
          </ion-col>
          <ion-col size="12" size-md="4">
            <div class="flex items-center gap-2 mb-2">
              <ion-icon name="person" class="text-purple-600"></ion-icon>
              <span>{{ project.proposalCount }} propuestas</span>
            </div>
          </ion-col>
        </ion-row>
      </ion-grid>

      <!-- Status Change Buttons (Only for project owner) -->
      @if (isProjectOwner && project.status === 'draft') {
      <div class="mt-4 pt-4 border-t border-gray-200">
        <ion-button (click)="changeProjectStatus(ProjectStatus.PUBLISHED)" color="primary"
          [disabled]="isUpdatingStatus">
          @if (isUpdatingStatus) {
          <ion-spinner name="lines-small" slot="start"></ion-spinner>
          }
          Publicar Proyecto
        </ion-button>
      </div>
      }
    </ion-card-content>
  </ion-card>

  <!-- Navigation Segments -->
  <ion-segment [(ngModel)]="currentSegment" (ionChange)="onSegmentChange($event)" class="mb-4">
    <ion-segment-button value="details">
      <ion-label>Detalles</ion-label>
    </ion-segment-button>
    @if (project.milestones && project.milestones.length > 0) {
    <ion-segment-button value="milestones">
      <ion-label>Hitos</ion-label>
    </ion-segment-button>
    }
    <ion-segment-button value="attachments">
      <ion-label>Archivos</ion-label>
    </ion-segment-button>
  </ion-segment>

  <!-- Content Sections -->
  @if (currentSegment === 'details') {
  <!-- Project Details -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Descripción del Proyecto</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <p class="mb-4 leading-relaxed">{{ project.description }}</p>

      <!-- Required Skills -->
      @if (project.requiredSkills && project.requiredSkills.length > 0) {
      <div class="mb-4">
        <h3 class="font-semibold mb-2">Habilidades Requeridas:</h3>
        <div class="flex flex-wrap gap-2">
          @for (skill of project.requiredSkills; track skill) {
          <ion-chip color="tertiary">
            <ion-label>{{ skill }}</ion-label>
          </ion-chip>
          }
        </div>
      </div>
      }

      <!-- Project Timeline -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div>
          <h4 class="font-semibold text-gray-700">Fecha de Inicio:</h4>
          <p>{{ formatDate(project.startDate) }}</p>
        </div>
        <div>
          <h4 class="font-semibold text-gray-700">Fecha de Finalización:</h4>
          <p>{{ formatDate(project.endDate) }}</p>
        </div>
        <div>
          <h4 class="font-semibold text-gray-700">Fecha Límite de Postulación:</h4>
          <p>{{ formatDate(project.applicationDeadline) }}</p>
        </div>
        <div>
          <h4 class="font-semibold text-gray-700">Experiencia Preferida:</h4>
          <p>{{ project.preferredExperience }}</p>
        </div>
      </div>
    </ion-card-content>
  </ion-card>
  }

  @if (currentSegment === 'milestones' && project.milestones && project.milestones.length > 0) {
  <!-- Milestones Section -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Hitos del Proyecto</ion-card-title>
    </ion-card-header>
    <ion-card-content class="p-0">
      <ion-list>
        @for (milestone of project.milestones; track milestone.id; let i = $index) {
        <ion-item>
          <div class="w-full">
            <div class="flex justify-between items-start mb-2">
              <h3 class="font-semibold">{{ milestone.title }}</h3>
              <div class="flex items-center gap-2">
                <ion-badge [color]="getMilestoneStatusColor(milestone.status)">
                  {{ milestone.status }}
                </ion-badge>
                <span class="font-semibold text-green-600">
                  ${{ milestone.amount.toLocaleString() }}
                </span>
              </div>
            </div>

            <p class="text-gray-600 mb-2">{{ milestone.description }}</p>

            @if (milestone.dueDate) {
            <div class="flex items-center gap-1 text-sm text-gray-500 mb-2">
              <ion-icon name="calendar"></ion-icon>
              <span>Fecha límite: {{ formatDate(milestone.dueDate) }}</span>
            </div>
            }

            @if (milestone.deliverables && milestone.deliverables.length > 0) {
            <div>
              <h4 class="font-medium text-sm mb-1">Entregables:</h4>
              <ul class="text-sm text-gray-600 list-disc list-inside">
                @for (deliverable of milestone.deliverables; track deliverable) {
                <li>{{ deliverable }}</li>
                }
              </ul>
            </div>
            }
          </div>
        </ion-item>
        @if (i < project.milestones!.length - 1) { <ion-item-divider></ion-item-divider>
          }
          }
      </ion-list>
    </ion-card-content>
  </ion-card>
  }

  @if (currentSegment === 'attachments') {
  <!-- Attachments Section -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Archivos Adjuntos</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      @if (project.attachments && project.attachments.length > 0) {
      <ion-list>
        @for (attachment of project.attachments; track attachment.id) {
        <ion-item button>
          <ion-icon name="document" slot="start"></ion-icon>
          <div>
            <h3>{{ attachment.name }}</h3>
            <p class="text-sm text-gray-500">
              {{ (attachment.size / 1024 / 1024).toFixed(2) }} MB
            </p>
          </div>
        </ion-item>
        }
      </ion-list>
      } @else {
      <div class="text-center py-8 text-gray-500">
        <ion-icon name="document" class="text-4xl mb-2"></ion-icon>
        <p>No hay archivos adjuntos</p>
      </div>
      }
    </ion-card-content>
  </ion-card>
  }

  <!-- Project Statistics -->
  <ion-card class="mt-4">
    <ion-card-header>
      <ion-card-title>Estadísticas del Proyecto</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-grid class="p-0">
        <ion-row>
          <ion-col size="6" size-md="3">
            <div class="text-center">
              <div class="text-2xl font-bold text-blue-600">{{ project.viewCount }}</div>
              <div class="text-sm text-gray-500">Visualizaciones</div>
            </div>
          </ion-col>
          <ion-col size="6" size-md="3">
            <div class="text-center">
              <div class="text-2xl font-bold text-green-600">{{ project.proposalCount }}</div>
              <div class="text-sm text-gray-500">Propuestas</div>
            </div>
          </ion-col>
          <ion-col size="6" size-md="3">
            <div class="text-center">
              <div class="text-2xl font-bold text-purple-600">
                {{ formatDate(project.createdAt) }}
              </div>
              <div class="text-sm text-gray-500">Fecha de Creación</div>
            </div>
          </ion-col>
          <ion-col size="6" size-md="3">
            <div class="text-center">
              <div class="text-2xl font-bold text-orange-600">
                {{ project.visibility }}
              </div>
              <div class="text-sm text-gray-500">Visibilidad</div>
            </div>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>
  } @else {
  <!-- Error State -->
  <div class="text-center py-8">
    <ion-icon name="alert-circle" class="text-6xl text-red-500 mb-4"></ion-icon>
    <h2 class="text-xl font-bold mb-2">Proyecto no encontrado</h2>
    <p class="text-gray-500">El proyecto que buscas no existe o no tienes permisos para verlo.</p>
  </div>
  }

  <!-- Alert Components -->
  <ion-alert trigger="delete-project-alert" header="Confirmar eliminación"
    message="¿Estás seguro de que deseas eliminar este proyecto? Esta acción no se puede deshacer."
    [buttons]="deleteAlertButtons">
  </ion-alert>

  <ion-alert trigger="status-change-alert" header="Cambiar estado del proyecto"
    message="¿Confirmas el cambio de estado?" [buttons]="statusChangeAlertButtons">
  </ion-alert>
</ion-content>